function selecionarMensagem(a){$("#Col_CaixaDeMensagens div").removeClass("msg_selecionada"),$(a).toggleClass("msg_selecionada"),$(a).removeClass("nao_lida").addClass("lida"),MostrarMensagem($(a).attr("msgId"))}function setMSGSend(a){$("#Nova_frame").hide(),$("#Resp_frame").hide(),dataMensagens=getData("Mensagens/email",usuarioId);for(var b=0;b<dataMensagens.length;b++)dataMensagens[b].idmensagens==SelMSGAcao&&(1==a?($("#Resp_frame").show(),$("#tela_over #Mensagem_wrapper #Resp_frame #mensagem_remetente").html(null!=dataMensagens[b].remetente.aluno?dataMensagens[b].remetente.aluno.nome:dataMensagens[b].remetente.professor.nome),$("#telxa_over #Mensagem_wrapper #Resp_frame #mensagem_destinatario").html(getNomeByNomeUsuario(dataMensagens[b].destinatarios,0)),$("#tela_over #Mensagem_wrapper #Resp_frame #Resposta_Remetente").val(dataMensagens[b].remetente.idusuario),$("#tela_over #Mensagem_wrapper #Resp_frame #mensagem_assunto").html(dataMensagens[b].assunto),$("#tela_over #Mensagem_wrapper #Resp_frame #Mensagem").val("\n\n-------------------------------------------------\n"+dataMensagens[b].mensagem)):2==a?($("#Nova_frame").show(),getNomeByNomeUsuario(dataMensagens[b].destinatarios,1),$("#tela_over #Mensagem_wrapper #Nova_frame #destinatarios option[value='"+dataMensagens[b].remetente.idusuario+"']").prop("selected",!0),$("#tela_over #Mensagem_wrapper #Nova_frame #destinatarios option[value='"+userID+"']").prop("selected",!1),formselect.multiselect("refresh"),$("#tela_over #Mensagem_wrapper #Nova_frame #assunto").val("RES: "+dataMensagens[b].assunto),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").empty(),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").val("\n\n-------------------------------------------------\n"+dataMensagens[b].mensagem)):3==a&&($("#Nova_frame").show(),$("#tela_over #Mensagem_wrapper #Nova_frame #assunto").val(dataMensagens[b].assunto),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").empty(),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").val("\n\n-------------------------------------------------\nDe: "+(null!=dataMensagens[b].remetente.aluno?dataMensagens[b].remetente.aluno.nome:dataMensagens[b].remetente.professor.nome)+"\nPara: "+getNomeByNomeUsuario(dataMensagens[b].destinatarios,0)+"\n\n"+dataMensagens[b].mensagem)));4==a&&($("#Nova_frame").show(),$("#tela_over #Mensagem_wrapper #Nova_frame #assunto").empty(),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").empty())}function MostrarMensagem(a){PLixo=a,$.ajax({type:"GET",async:!1,crossDomain:!0,url:path+"Mensagens/MensagemByUser/"+usuarioId+"/"+a,success:function(b){$("#Col_Mensagem #Mensagem_wrapper #mensagem_remetente").html(null!=b[0].remetente.aluno?b[0].remetente.aluno.nome:b[0].remetente.professor.nome),$("#Col_Mensagem #Mensagem_wrapper #mensagem_destinatario").html(getNomeByNomeUsuario(b[0].destinatarios)),$("#Col_Mensagem #Mensagem_wrapper #Resposta_Remetente").val(b[0].remetente.idusuario),$("#Col_Mensagem #Mensagem_wrapper #mensagem_assunto").html(b[0].assunto),$("#Col_Mensagem #Mensagem_wrapper #Mensagem").html(b[0].mensagem),SelMSGAcao=a,"N"==b[0].lida&&$.ajax({url:path+"Mensagens/update/lida/"+a+"/S",type:"POST",success:function(a){console.log(a)}})}})}function enviar(){loading("inicial"),EnviarMSG()}function EnviarMSG(){return $("#frm_Envia_Mensagens #remetente").attr("value",""+userID),null!=$("#frm_Envia_Mensagens #destinatarios").val()&&""!=$("#frm_Envia_Mensagens #mensagem").val()&&""!=$("#frm_Envia_Mensagens #assunto").val()?$.ajax({url:path+"Mensagens/",type:"POST",data:$("#frm_Envia_Mensagens").serialize(),success:function(a){return observacaoProducao&&($.ajax({url:path+"ProducaoAluno/Status/"+localStorage.getItem("observacaoProducao")+"/2/"+(a-1),type:"GET",async:!0,crossDomain:!0,beforeSend:function(){loading("inicial")},success:function(){},erro:function(){mensagem("N\xe3o modificado","OK","bt_ok","erro")},complete:function(){loading("final")}}),observacaoProducao=!1),$("#tela_over").hide(),mensagem("Mensagem enviada com sucesso!","OK","bt_ok","sucesso"),ListarEnviadas("",1,10),limparCampos(),loading("final"),!1},error:function(){mensagem("Erro ao enviar mensagem!","OK","bt_ok","erro"),loading("final")}}):null==$("#frm_Envia_Mensagens #destinatarios").val()?(mensagem("N\xe3o h\xe1 destinat\xe1rios, por favor, adicione ao menos um destinat\xe1rio!","OK","bt_ok","erro"),loading("final")):""==$("#frm_Envia_Mensagens #assunto").val()?(mensagem("N\xe3o h\xe1 assunto, por favor, adicione um assunto que deseja enviar!","OK","bt_ok","erro"),loading("final")):""==$("#frm_Envia_Mensagens #mensagem").val()&&(mensagem("N\xe3o h\xe1 mensagem, por favor, adicione a mensagem que deseja enviar!","OK","bt_ok","erro"),loading("final")),!1}function ResponderMensagem(){$("#frm_Envia_Mensagens #remetente").attr("value",""+userID),""!=$("#tela_over #Mensagem").val()?$.ajax({url:path+"Mensagens/",type:"POST",data:"id=0&action=create&lida=1&remetente="+userID+"&assunto=RE: "+$("#tela_over #mensagem_assunto").html()+"&destinatarios="+$("#tela_over #Resposta_Remetente").val()+"&mensagem="+$("#tela_over #Mensagem").val(),success:function(){dataMensagens=getData("Mensagens",null),$("#tela_over").hide(),$("#CaixaDeEntrada").trigger("click"),ListarCaixaEntrada(1,10),mensagem("Mensagem enviada com sucesso!","OK","bt_ok","sucesso")},error:function(){mensagem("Erro ao enviar mensagem!","OK","bt_ok","erro"),loading("final"),dataMensagens=getData("Mensagens",null)}}):(mensagem("Sua resposta n\xe3o tem mensagem, por favor, adicione uma!","OK","bt_ok","erro"),loading("final"))}function ListarCaixaEntrada(a,b){var c="",d=1;$.ajax({type:"GET",async:!1,crossDomain:!0,url:path+"Mensagens/email/entrada/"+usuarioId+"/"+a+"/"+b,success:function(b){for(var e=b.length-1;e>=0;e--){var f=b[e].data.substr(8,2)+"/"+b[e].data.substr(5,2)+"/"+b[e].data.substr(0,4);"Aluno"!=usuario||null==b[e].proprietario.aluno&&""==b?"Professor"!=usuario&&"Coordenacao"!=usuario&&"Secretaria"!=usuario||null==b[e].proprietario.professor&&""!=b||b[e].proprietario.idusuario==userID&&"S"==b[e].cxEntrada&&(c+='<div id="msg'+d++ +'" class="caixa_mensagem'+("N"==b[e].lida?" nao_lida":" lida")+'" msgId="'+b[e].idmensagens+'" onclick="selecionarMensagem(this);"> <div class="caixa_data_hora"> '+f+' </div><div class="msg_info_wrapper"><div class="caixa_remetente"> '+(null!=b[e].remetente.aluno?b[e].remetente.aluno.nome:b[e].remetente.professor.nome)+' </div><div class="caixa_assunto"> '+(""!=b[e].assunto?b[e].assunto:"Sem Assunto")+"</div></div></div>"):b[e].proprietario.idusuario==userID&&"S"==b[e].cxEntrada&&(c+='<div id="msg'+d++ +'" class="caixa_mensagem'+("N"==b[e].lida?" nao_lida":" lida")+'" msgId="'+b[e].idmensagens+'" onclick="selecionarMensagem(this);"> <div class="caixa_data_hora"> '+f+' </div><div class="msg_info_wrapper"><div class="caixa_remetente"> '+(null!=b[e].remetente.aluno?b[e].remetente.aluno.nome:b[e].remetente.professor.nome)+' </div><div class="caixa_assunto"> '+(""!=b[e].assunto?b[e].assunto:"Sem Assunto")+"</div></div></div>")}1==a?$("#Col_CaixaDeMensagens").html(c):$("#Col_CaixaDeMensagens").append(c)}})}function ListarEnviadas(a,b,c){var d="",e=1;$.ajax({type:"GET",async:!1,crossDomain:!0,url:path+"Mensagens/email/enviado/"+usuarioId+"/"+b+"/"+c,success:function(c){if(""==c)return $("#Col_CaixaDeMensagens").html(""),0;for(var f=c.length-1;f>=0;f--){var g=c[f].data.substr(8,2)+"/"+c[f].data.substr(5,2)+"/"+c[f].data.substr(0,4);"Aluno"!=usuario||null==c[f].remetente.aluno&&""==c?"Professor"!=usuario&&"Coordenacao"!=usuario&&"Secretaria"!=usuario||null==c[f].remetente.professor&&""==c||c[f].remetente.idusuario==userID&&"S"==c[f].cxEnviada&&(d+='<div id="msg'+e++ +'" class="caixa_mensagem'+("N"==c[f].lida?" nao_lida":" lida")+'" msgId="'+c[f].idmensagens+'" onclick="selecionarMensagem(this);"> <div class="caixa_data_hora"> '+g+' </div><div class="msg_info_wrapper"><div class="caixa_remetente"> '+c[f].remetente.professor.nome+' </div><div class="caixa_assunto"> '+(""!=c[f].assunto?c[f].assunto:"Sem Assunto")+"</div></div></div>"):c[f].remetente.idusuario==userID&&"S"==c[f].cxEnviada&&(d+='<div id="msg'+e++ +'" class="caixa_mensagem'+("N"==c[f].lida?" nao_lida":" lida")+'" msgId="'+c[f].idmensagens+'" onclick="selecionarMensagem(this);"> <div class="caixa_data_hora"> '+g+' </div><div class="msg_info_wrapper"><div class="caixa_remetente"> '+c[f].remetente.aluno.nome+' </div><div class="caixa_assunto"> '+(""!=c[f].assunto?c[f].assunto:"Sem Assunto")+"</div></div></div>")}var h;h=""!=a?a+d:d,1==b?$("#Col_CaixaDeMensagens").html(d):$("#Col_CaixaDeMensagens").append(d)}})}function ExcluirMensagem(){PLixo>0&&$.ajax({type:"GET",async:!1,crossDomain:!0,url:path+"Mensagens/delete/"+PLixo,success:function(){PLixo=0},error:function(a){405==a.status&&(PLixo=0,$(".msg_selecionada").next().addClass("nextAccept"),$(".msg_selecionada").remove(),dataMensagens=null,dataMensagens=getData("Mensagens",null),$("#Mensagem_wrapper #mensagem_remetente").html(""),$("#Mensagem_wrapper #mensagem_destinatario").html(""),$("#Mensagem_wrapper #mensagem_assunto").html(""),$("#Mensagem_wrapper #Mensagem").html(""),$("#frm_Post_Mensagens #id").val(""),$("#frm_Post_Mensagens #action").val(""),$("#frm_Post_Mensagens #remetente").val(""),$("#frm_Post_Mensagens #assunto").val(""),$("#frm_Post_Mensagens #mensagem").val(""),$("#frm_Post_Mensagens #lida").val(""),$("#frm_Post_Mensagens #cxEntrada").val(""),$("#frm_Post_Mensagens #cxEnviada").val(""),$("#frm_Post_Mensagens #tipoMensagem").val(""),$("#frm_Post_Mensagens #data").val(""),$("#frm_Post_Mensagens #proprietario").val(""),$("#frm_Post_Mensagens #destinatarios").val(""),$(".nextAccept").trigger("click"),$(".nextAccept").removeClass("nextAccept"),carregaMensagens(),mensagem("Mensagem excluida com sucesso!","OK","bt_ok","sucesso"),loading("final"))}}).then(function(){dataMensagens=null,dataMensagens=getData("Mensagens",null),loading("final")})}function getAlunoByUsuario(){for(var a=0;a<dataUsuario.length;a++)if("Aluno"==usuario&&null!=dataUsuario[a].aluno){if(dataUsuario[a].idusuario==userID)return dataUsuario[a].aluno.idAluno}else if("Professor"==usuario&&null!=dataUsuario[a].professor&&dataUsuario[a].idusuario==userID)return dataUsuario[a].professor.idprofessorFuncionario}function getNomeByNomeUsuario(a,b){for(var c=a.split(";"),d="",e=0;e<c.length;e++)for(var f=0;f<dataUsuario.length;f++)dataUsuario[f].login==c[e]&&(null!=dataUsuario[f].aluno?d+=dataUsuario[f].aluno.nome+"; ":null!=dataUsuario[f].professor&&(d+=dataUsuario[f].professor.nome+"; "),1==b&&$("#tela_over #Mensagem_wrapper #Nova_frame #destinatarios option[value='"+dataUsuario[f].idusuario+"']").prop("selected",!0));return d}function limparCampos(){$("#tela_over #Mensagem_wrapper #Nova_frame #assunto").val(""),$("#tela_over #Mensagem_wrapper #Nova_frame #mensagem").val(""),$("#pesquisaParaMensagem").val(""),$(".ui-multiselect-checkboxes li").css("display","block"),$(":checkbox").removeAttr("checked"),$(".ui-multiselect span").eq(1).text("Para")}var dataUsuario=getData("Usuario",null),userID=usuarioId,alunoID=getAlunoByUsuario(),dataMensagens,dataMensagensEntrada,dataMensagensSaida,observacaoProducao=!1;ListarCaixaEntrada(1,10);var IdMsg=GetURLParameter("ID"),PLixo=0,arrayUsuariosID=[],arrayUsuariosNome=[],SelMSGAcao=0;$(document).ready(function(){var c,a=1,b=!1;$("#boxMensagens").mCustomScrollbar({axis:"y",callbacks:{alwaysTriggerOffsets:!1,onTotalScrollOffset:100,whileScrolling:function(){c=$(".cx_barra").attr("id"),"Enviadas"==c?this.mcs.topPct>95&&0==b&&(retorno=ListarEnviadas("",10*a,10),a++,"undefined"==typeof retorno&&(b=!0)):this.mcs.topPct>95&&0==b&&(retorno=ListarCaixaEntrada(10*a,10),a++,"undefined"==typeof retorno&&(b=!0))},onTotalScroll:function(){c=$(".cx_barra").attr("id"),"Enviadas"==c?this.mcs.topPct>95&&0==b&&(retorno=ListarEnviadas("",10*a,10),a++,"undefined"==typeof retorno&&(b=!0)):this.mcs.topPct>95&&0==b&&(retorno=ListarCaixaEntrada(10*a,10),a++,"undefined"==typeof retorno&&(b=!0))}}}),$("#Nav_menu div").click(function(){"bt_Excluir"==$(this).attr("id")&&$(".msg_selecionada").length>0&&(loading("inicial"),setTimeout(ExcluirMensagem,1e3)),"bt_Excluir"!=$(this).attr("id")&&$(".msg_selecionada").length>0&&(1==$(this).hasClass("estado_ativo")?$(this).removeClass("estado_ativo"):($("#Nav_menu div").removeClass("estado_ativo"),$(this).addClass("estado_ativo"))),$("#menu_responder").hide()}),$("#bt_Responder").click(function(){1==$("#bt_Responder").hasClass("estado_ativo")&&$(".msg_selecionada").length>0?$("#menu_responder").show():$("#menu_responder").hide()}),$("span#responder").click(function(){$("#tela_over").show(),$("#menu_responder").hide(),$("#Nav_menu div").removeClass("estado_ativo"),setMSGSend(1)}),$("span#responder_todos").click(function(){$("#tela_over").show(),$("#menu_responder").hide(),$("#Nav_menu div").removeClass("estado_ativo"),setMSGSend(2)}),$("span#encaminhar").click(function(){$("#tela_over").show(),$("#menu_responder").hide(),$("#Nav_menu div").removeClass("estado_ativo"),setMSGSend(3)}),$("#bt_resp_cancelar").click(function(){$("#Nav_menu div").removeClass("estado_ativo"),$("#tela_over").hide()}),$("#bt_Escrever").click(function(){$("#tela_over").show(),setMSGSend(4),$("#Nav_menu div").removeClass("estado_ativo")}),$("#bt_enviar_cancelar").click(function(){return limparCampos(),$("#tela_over").hide(),observacaoProducao=!1,!1}),$("#bt_resp_enviar").click(function(){ResponderMensagem(),$("#Nav_menu div").removeClass("estado_ativo")}),$("body").delegate(".ui-multiselect-none","click",function(){return $(":checkbox").removeAttr("checked"),$("#pesquisaParaMensagem").val(""),$("#pesquisaParaMensagem").focus(),$(".ui-multiselect-checkboxes li").css("display","block"),$(".ui-multiselect span").eq(1).text("Para"),!1}),$("#Col_Menu div").click(function(){$("#Col_Menu div").removeClass("estado_ativo"),$("#Col_Menu div").removeClass("cx_barra"),$(this).toggleClass("estado_ativo"),$("#mCSB_5_dragger_vertical").css({position:"absolute",top:"0px"}),$("#mCSB_5_container").css({position:"relative",top:"0px",left:"0px"}),a=1,b=!1,"CaixaDeEntrada"==$(this).attr("id")?($(this).addClass("cx_barra"),ListarCaixaEntrada(1,10)):"Enviadas"==$(this).attr("id")&&($(this).addClass("cx_barra"),ListarEnviadas("",1,10)),$("#Mensagem_wrapper #mensagem_remetente").html(""),$("#Mensagem_wrapper #mensagem_destinatario").html(""),$("#Mensagem_wrapper #mensagem_assunto").html(""),$("#Mensagem_wrapper #Mensagem").html(""),PLixo=0});for(var d=0;d<dataUsuario.length;d++){var e=!1;null!=dataUsuario[d].professor?(arrayUsuariosID[arrayUsuariosID.length]=dataUsuario[d].professor.idprofessorFuncionario,arrayUsuariosNome[arrayUsuariosNome.length]=dataUsuario[d].professor.nome,e=!0):null!=dataUsuario[d].aluno&&(arrayUsuariosID[arrayUsuariosID.length]=dataUsuario[d].aluno.idAluno,arrayUsuariosNome[arrayUsuariosNome.length]=dataUsuario[d].aluno.nome,e=!0),e&&$("#tela_over #Mensagem_wrapper #destinatarios").append('<option title="'+dataUsuario[d].perfil.perfil+'" value="'+dataUsuario[d].idusuario+'">'+arrayUsuariosNome[arrayUsuariosNome.length-1]+"</option>")}if($("#tela_over #Mensagem_wrapper #destinatarios").append($("#tela_over #Mensagem_wrapper #destinatarios option").remove().sort(function(a,b){var c=$(a).text(),d=$(b).text();return c>d?1:c<d?-1:0})),ListarCaixaEntrada(1,10),window.setTimeout(function(){void 0!=IdMsg&&($(".caixa_mensagem[msgid='"+IdMsg+"']").trigger("click"),scrollBarMensagem.mCustomScrollbar("scrollTo",$(".caixa_mensagem[msgid='"+IdMsg+"']")))},1e3),null!=localStorage.getItem("producaoMensagem")&&""!=localStorage.getItem("producaoMensagem")&&(localStorage.setItem("observacaoProducao",localStorage.getItem("producaoMensagem")),localStorage.setItem("producaoMensagem",""),observacaoProducao=!0,$("#bt_Escrever").trigger("click"),window.setTimeout(function(){var a;$.ajax({url:path+"ProducaoAluno/"+localStorage.getItem("observacaoProducao"),async:!1,crossDomain:!0,type:"GET",success:function(b){a=b}});var b;$.ajax({url:path+"Usuario/aluno/"+a.aluno.idAluno,async:!1,crossDomain:!0,type:"GET",success:function(a){b=a}}),$("[id^='ui-multiselect-destinatarios-option'][value="+b.idusuario+"]").trigger("click"),$("#frm_Envia_Mensagens #assunto").val(a.tipo.tipo+" - "+a.texto)},1500)),null!=localStorage.getItem("respostaObservacao")&&""!=localStorage.getItem("respostaObservacao")){var f=localStorage.getItem("respostaObservacao");localStorage.setItem("respostaObservacao",""),window.setTimeout(function(){$("[msgid="+f+"]").trigger("click"),$("#responder").trigger("click")},1500)}});